<!DOCTYPE html>
<html>

<head>
    <title>Firebase a Leaflet Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }


        #map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>


<body>
    <div id="map"></div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Your Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDMjvenwB5pmrJA6D-lO5RqfwdWouf22FY",
            authDomain: "laporinaja-f02fb.firebaseapp.com",
            databaseURL: "https://laporinaja-f02fb-default-rtdb.firebaseio.com",
            projectId: "laporinaja-f02fb",
            storageBucket: "laporinaja-f02fb.firebasestorage.app",
            messagingSenderId: "961004006034",
            appId: "1:961004006034:web:925b1d98ef40bff6cad44b",
            measurementId: "G-V7P2DF11XT"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Initialize the map
        const map = L.map('map').setView([-7.403918488986842, 109.98991291772167], 13);

        // Add a tile layer (the map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Get a reference to the database service
        const pointsRef = database.ref("/laporan");

        // Attach an asynchronous callback to read the data at our posts reference
        pointsRef.on("value", (snapshot) => {
            const data = snapshot.val();
            console.log(data);
            if (data) {
                // Clear existing markers
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                Object.keys(data).forEach((key) => {
                    const point = data[key];
                    if (point.lokasi) {
                        //change lokasi to float
                        point.lokasi = point.lokasi.split(",").map(parseFloat);
                        if (isNaN(point.lokasi[0]) || isNaN(point.lokasi[1])) return;

                        const marker = L.marker(point.lokasi).addTo(map);
                        const popup = `${point.jenisInfra}<br>${point.lokasi}<br>
                        <button onclick="editPoint('${key}')">
                            <i class="fa-solid fa-pen-to-square"></i> Edit
                        </button>
                        &nbsp;
                        <button onclick="deletePoint('${key}')"><i class="fa-solid fa-trash"></i> Delete</button>`;
                        if (point.jenisInfra) {
                            marker.bindPopup(popup);
                        }
                    }
                });
            }
        }, (errorObject) => {
            console.log("The read failed: " + errorObject.name);
        });

        // Make functions globally available
        window.editPoint = function (key) {
            window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'EDIT_POINT', key: key }));
        }

        window.deletePoint = function (key) {
            if (confirm("Yakin akan menghapus point ini?")) {
                database.ref(`/laporan/${key}`).remove()
                    .then(() => {
                        // Don't reload, onValue will handle the update
                    }).catch((error) => {
                        console.error("Delete failed: ", error);
                    });
            }
        }
    </script>
</body>

</html>